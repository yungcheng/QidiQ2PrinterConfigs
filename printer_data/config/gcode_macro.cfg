#  Q2
#ADDED
# Add to start gcode:  ORCA_QIDI_BOX T=[initial_tool]
# T0-3 for QIDI BOX slots 1A-1D.  If more boxes are connected,
# additional tools will be written in the same order.
# Any tool number higher than the configured box slots or -1 
# will disable the BOX and use the rack. 

[gcode_macro ORCA_QIDI_BOX] 
gcode: 
    # Grab the inital tool number, save to variable t 
    {% set t = params.get('T') | int %}

    # Check if at least one BOX is connected
    {% if printer.save_variables.variables.box_count >= 1 %}

        # Check if initial tool is external spool (not in BOX)
        {% if t >= printer.save_variables.variables.box_count * 4 or t == -1 %}
            # Disable the BOX and desync any synced slots
            SAVE_VARIABLE VARIABLE=enable_box VALUE=0

        {% else %}
            # If initial tool is in range for BOX, enable the BOX
            SAVE_VARIABLE VARIABLE=enable_box VALUE=1

            # Set tools T0 through T3 to slot0 through slot3
            SAVE_VARIABLE VARIABLE=value_t0 VALUE="'slot0'"
            SAVE_VARIABLE VARIABLE=value_t1 VALUE="'slot1'"
            SAVE_VARIABLE VARIABLE=value_t2 VALUE="'slot2'"
            SAVE_VARIABLE VARIABLE=value_t3 VALUE="'slot3'"

            # If additional BOXes are connected, set those tools too
            {% if printer.save_variables.variables.box_count >= 2 %}
                SAVE_VARIABLE VARIABLE=value_t4 VALUE="'slot4'"
                SAVE_VARIABLE VARIABLE=value_t5 VALUE="'slot5'"
                SAVE_VARIABLE VARIABLE=value_t6 VALUE="'slot6'"
                SAVE_VARIABLE VARIABLE=value_t7 VALUE="'slot7'"
            {% endif %}

            {% if printer.save_variables.variables.box_count >= 3 %}
                SAVE_VARIABLE VARIABLE=value_t8 VALUE="'slot8'"
                SAVE_VARIABLE VARIABLE=value_t9 VALUE="'slot9'"
                SAVE_VARIABLE VARIABLE=value_t10 VALUE="'slot10'"
                SAVE_VARIABLE VARIABLE=value_t11 VALUE="'slot11'"
            {% endif %}

            {% if printer.save_variables.variables.box_count == 4 %}
                SAVE_VARIABLE VARIABLE=value_t12 VALUE="'slot12'"
                SAVE_VARIABLE VARIABLE=value_t13 VALUE="'slot13'"
                SAVE_VARIABLE VARIABLE=value_t14 VALUE="'slot14'"
                SAVE_VARIABLE VARIABLE=value_t15 VALUE="'slot15'"
            {% endif %}
        {% endif %}
    {% else %}
        # If no boxes are connected, disable the BOX
        SAVE_VARIABLE VARIABLE=enable_box VALUE=0
    {% endif %}

[gcode_macro PRINTER_PARAM]
variable_max_x_position: 270.0
variable_max_y_position: 270.0
variable_max_z_position: 260.0
variable_clear_x_position :88.0
variable_clear_y_position :287.0
gcode:

[gcode_macro _CG28]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}



[gcode_macro save_zoffset]
gcode:
    {% if printer.gcode_move.homing_origin.z < 0.5 %}
       SAVE_VARIABLE VARIABLE=z_offset VALUE={printer.gcode_move.homing_origin.z}
    {% endif %}

[gcode_macro set_zoffset]        
gcode:
    {% set z = printer.save_variables.variables.z_offset|default(0) %}
    SET_GCODE_OFFSET Z={z} MOVE=0


[gcode_macro CLEAR_NOZZLE_PLR]
gcode:
    {% set hotendtemp = params.HOTEND|default(250)|int %}
    G91
    G1 Z{5} F900 
    G90

    MOVE_TO_TRASH

    M109 S{hotendtemp}

    G92 E0
    G1 E80 F400
    M106 S255

    G1 X115 F5000
    G1 X95 F15000
    G1 X115 F5000
    G1 X95 F15000
    G1 X115 F5000
    G1 X95 F15000
    G1 X115 F5000
    G1 X95 F15000
    G1 X125 F15000


[gcode_macro CLEAR_NOZZLE]
gcode:
    {% set hotendtemp = params.HOTEND|default(250)|int %}
    MOVE_TO_TRASH
    M400
    M109 S{hotendtemp}
#    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={hotendtemp-20}
    G92 E0
    G1 E5 F80
    G92 E0
    G1 E80 F300
    G92 E0
    G1 E-2 F200
    M400
    M106 S255
    G4 P1000
    M104 S140
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={hotendtemp-30}

    M204 S5000
        G1 X103 F5000
        G1 X90 F5000
        G1 X103 F5000
        G1 X90 F5000
        G1 X103 F5000
        G1 X90 F5000
        G1 X103 F5000
        G1 X90 F5000
        G1 X103 F5000
        G1 X90 F5000

        G1 X114 F5000
        G1 X100 F5000
        G1 X114 F5000
        G1 X100 F5000
        G1 X114 F5000
        G1 X100 F5000
        G1 X114 F5000
        G1 X100 F5000
        G1 X114 F5000
        G1 X100 F5000
        G1 X114 F5000
        G1 X100 F5000
        G1 X114 F5000
        G1 X100 F5000

        G1 X103 F5000
        G1 X90 F5000
        G1 X103 F5000
        G1 X90 F5000
        G1 X103 F5000
        G1 X90 F5000
        G1 X103 F5000
        G1 X90 F5000
        G1 X103 F5000
        G1 X90 F5000

    
    G1 X125 F15000
    
    G1 X130 Y280 F6000
    G1 Z-0.2 F600

    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=150
    M106 S255
    G2 I0.5 J0.5 F600
    G2 I0.5 J0.5 F600
    G2 I0.5 J0.5 F600
    G1 X140 F200
    G1 Y281 F200
    G1 X130 F200
    G1 Y283 F200
    G1 X140 F200

    G2 I0.5 J0.5 F600
    G2 I0.5 J0.5 F600
    G2 I0.5 J0.5 F600

    G1 Z0.2
    G1 X180 F12000
    G1 Z-1.5
    G1 X164 F12000
    G1 X180 F12000
    G1 X164 F12000
    G1 X180 F12000
    G1 X164 F12000
    G1 X180 F12000
    G1 X164 F12000
    M400
    M118 Nozzle cleared
    G1 Z30 F900
    G1 Y10 F18000
    G1 X260 F18000
    M106 S0

[gcode_macro SHAKE_OOZE]
gcode:
    MOVE_TO_TRASH
    M204 S2000
    M400
    G4 P500
    G91 
    {% for y in range(1,14) %}
        G1 Y-1 F20000
#        G4 P50
        G1 Y1 F20000
#       G4 P50
    {% endfor %}
    G90

[gcode_macro MOVE_TO_TRASH]
gcode:
#    _CG28
    
    {% if "xy" not in printer.toolhead.homed_axes %}
        G28 X Y
    {% endif %}
    M204 S5000
    {% if (printer.gcode_move.position.y) > 270 %}
        {% if (printer.gcode_move.position.x) > 112 or (printer.gcode_move.position.x) < 85 %}
            G1 Y270 F20000
            G1 X85 F20000
            G1 Y270 F20000
            G1 Y287.5 F3000
        {% endif %}
        G1 X85 F20000
        G1 Y287.5 F3000
    {% else %}
        G1 X85 F20000
        G1 Y260 F20000
        G1 Y287.5 F3000
    {% endif %}

[gcode_macro EXTRUSION_AND_FLUSH]
gcode:
    {% set hotendtemp = params.HOTEND|int %}
    MOVE_TO_TRASH
    M109 S{hotendtemp}
    M83
    {% for i in range(4) %}
        G1 X{85 + i % 2 * 3} F5000
        {% for j in range(1,6) %}
            G1 E9 F300
            G1 E1 F50
        {% endfor %}
    {% endfor %}
    G1 E-1 F1800
    M400
    M106 S255
    M400
    G4 P5000
    CLEAR_OOZE
    CLEAR_FLUSH
    MOVE_TO_TRASH
    M106 S0

[gcode_macro PRINT_START]
gcode:
    AUTOTUNE_SHAPERS
    DISABLE_ALL_SENSOR
    CLEAR_PAUSE
    
    {% set bedtemp = params.get('BED') | int %}
    {% set hotendtemp = params.get('HOTEND') | int %}
    {% set chambertemp = params.get('CHAMBER', 0) | int %}
    {% set extruder = params.EXTRUDER|default(0)|int %}

    M104 S0
    {% if chambertemp == 0 %}
        M106 P3 S255
    {% endif %}
    M140 S{bedtemp}    
    G28   
    M141 S{chambertemp}    
    SET_GCODE_OFFSET Z=0 MOVE=0
    BUFFER_MONITORING ENABLE=0
    {% if printer.save_variables.variables.box_count >= 1 and printer["box_extras"] %} 
        SAVE_VARIABLE VARIABLE=load_retry_num VALUE=0
        SAVE_VARIABLE VARIABLE=retry_step VALUE=None
        CLEAR_TOOLCHANGE_STATE
        {% for i in range(16) %}
            SAVE_VARIABLE VARIABLE=runout_{i} VALUE=0
            G4 P100
        {% endfor %}
        {% if printer.save_variables.variables.enable_box == 1 %}
            BOX_PRINT_START EXTRUDER={extruder} HOTENDTEMP={hotendtemp}
            M400
            EXTRUSION_AND_FLUSH HOTEND={hotendtemp}
        {% endif %}
    {% endif %}

    CLEAR_NOZZLE HOTEND={hotendtemp}
    #切料调平
    CUT_FILAMENT_1
    M104 S140
    G4 P3000
    M400
    G28    
    Z_TILT_ADJUST
    

    M104 S140
    M190 S{bedtemp}   
    M191 S{chambertemp}
    M400
    G4 P3000
    
    G29
    G0 Z50 F600
    G0 X260 Y5  F30000
    {% if printer.save_variables.variables.box_count >= 1 and printer["box_extras"] and printer.save_variables.variables.enable_box == 1 %}
        BUFFER_MONITORING ENABLE=1 
    {% endif %}
    M191 S{chambertemp}
    M109 S{hotendtemp}
    M204 S10000

    set_zoffset
    ENABLE_ALL_SENSOR
    save_last_file

[gcode_macro ENABLE_ALL_SENSOR]
gcode:
    SET_FILAMENT_SENSOR SENSOR=filament_switch_sensor ENABLE=1

[gcode_macro DISABLE_ALL_SENSOR]
gcode:
    SET_FILAMENT_SENSOR SENSOR=filament_switch_sensor ENABLE=0

[gcode_macro AUTOTUNE_SHAPERS]
variable_autotune_shapers: 'ei'
gcode:

[gcode_macro M84]
rename_existing:M84.1
gcode:
    M84.1
	SET_STEPPER_ENABLE STEPPER=stepper_x enable=0
	SET_STEPPER_ENABLE STEPPER=stepper_y enable=0
	SET_STEPPER_ENABLE STEPPER=stepper_z enable=0
    SET_STEPPER_ENABLE STEPPER=stepper_z1 enable=0
	SET_STEPPER_ENABLE STEPPER=extruder enable=0
	
[gcode_macro DETECT_INTERRUPTION]
gcode:
    {% set was_interrupted = printer.save_variables.variables.was_interrupted %}
    {% if was_interrupted %}
    M118 Detected unexpected interruption during the last print. Do you want to resume printing? (Do not move the extruder before resuming.)
    M118 Yes: RESUME_INTERRUPTED
    M118 No: CLEAR_LAST_FILE
    {% endif %}

[delayed_gcode PRINTER_INIT]
initial_duration:0.2
gcode:
	SET_STEPPER_ENABLE STEPPER=stepper_z enable=1
    SET_STEPPER_ENABLE STEPPER=stepper_z1 enable=1
    BED_MESH_CLEAR      
#    DETECT_INTERRUPTION
    DISABLE_ALL_SENSOR


[gcode_macro _HOME_X]
gcode:
    {% set HOME_CUR = 0.9 %}
    {% set driver_config = printer.configfile.settings['tmc2240 stepper_x'] %}
    {% set RUN_CUR = driver_config.run_current %}
    
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CUR} 
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CUR} 
    G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CUR}     
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CUR} 
    BEEP I=1 DUR=100   
    G91    
    G1 X-10 F3000
    G90

[gcode_macro _HOME_Y]
gcode:
    {% set HOME_CUR = 0.9 %}
    {% set driver_config = printer.configfile.settings['tmc2240 stepper_x'] %}
    {% set RUN_CUR = driver_config.run_current %}
    
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CUR} 
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CUR} 
    G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CUR}     
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CUR} 
    BEEP I=1 DUR=100   
    G91    
    G1 Y10 F3000
    G90    

[gcode_macro _HOME_XY]
gcode:   
    _HOME_Y
    _HOME_X
    _HOME_Y


[homing_override]
axes:xy
gcode: 

    M204 S10000
    M220 S100
    SET_STEPPER_ENABLE STEPPER=extruder enable=0
	{% if 'X' in params and 'Y' not in params %}
        _HOME_X
    {% endif %}

	{% if 'Y' in params and 'X' not in params %}
        _HOME_Y
    {% endif %}

    {% if 'X' in params and 'Y' in params %}
        _HOME_XY
    {% endif %}

    {% if 'X' not in params and  'Y' not in params  %}
        SET_KINEMATIC_POSITION X=100
        SET_KINEMATIC_POSITION Y=100
        SET_KINEMATIC_POSITION Z={printer.toolhead.axis_maximum.z/2}
        G91
        G1 Z5 F600
#        G1 X-5 F2400
#        G1 Y2 F2400
        G4 P2000
        _HOME_XY
        G90
        G1 X{printer['gcode_macro PRINTER_PARAM'].max_x_position/2} Y{printer['gcode_macro PRINTER_PARAM'].max_y_position/2} F7800
        G91
        M400       
        G28 Z
        G1 Z20 F600
    {% endif %}
    M204 S10000   
    G90


[gcode_macro SHAPER_CALIBRATE]
rename_existing: RESHAPER_CALIBRATE
gcode:
    RESHAPER_CALIBRATE FREQ_START=20 FREQ_END=150
    
[gcode_macro PRINT_END]
gcode:
    M400
    save_zoffset
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}
    CLEAR_PAUSE
    M106 P2 S0
    M106 P0 S0
    # M106 P3 S0
    DISABLE_BOX_HEATER
    
    M104 S0
    M140 S0
    M141 S0

    M220 S100
    M221 S100
    M84
	
    DISABLE_ALL_SENSOR
    {% if printer.save_variables.variables.box_count >= 1 and printer.save_variables.variables.enable_box == 1 and printer["box_extras"]%}
        BUFFER_MONITORING ENABLE=0
    {% endif %}
#    SET_GCODE_OFFSET Z=0 MOVE=0
    BED_MESH_CLEAR
    G31
    CLEAR_LAST_FILE
    BEEP I=2 DUR=500
    SDCARD_RESET_FILE

[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    {% if "xyz" in printer.toolhead.homed_axes %}
        M204 S10000   
        G90
        {% if (printer.gcode_move.position.z) < 100 %}
        G1 Z100 F600                                       
        {% endif %}
        {% if (printer.gcode_move.position.y) > printer['gcode_macro PRINTER_PARAM'].max_y_position %}
            G1 Y{printer['gcode_macro PRINTER_PARAM'].max_y_position - 50} F6000                                       
        {% endif %}
        G1  X265 Y5 F7800
    {% endif %}
    {% if printer.save_variables.variables.box_count >= 1 and printer.save_variables.variables.enable_box == 1 and printer["box_extras"]%}
        BUFFER_MONITORING ENABLE=0
    {% endif %}
    M400
    save_zoffset
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}

    M106 P2 S0
    M106 P0 S0
    M106 P3 S0
    
    M104 S0
    M140 S0
    M141 S0
    DISABLE_BOX_HEATER

    M220 S100
    M221 S100
    M84
	
    DISABLE_ALL_SENSOR
    SET_GCODE_OFFSET Z=0 MOVE=0
    BED_MESH_CLEAR
    G31
    BEEP I=2 DUR=500

    BASE_CANCEL_PRINT
    CLEAR_LAST_FILE
    M118 Canceled print!

[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
    # Parameters
    {% set z = params.Z|default(5)|int %}
    
    {% if printer['pause_resume'].is_paused|int == 0 %}     
        SET_GCODE_VARIABLE MACRO=RESUME_PRINT VARIABLE=zhop VALUE={z}
        SET_GCODE_VARIABLE MACRO=RESUME_PRINT VARIABLE=etemp VALUE={printer['extruder'].target}
        SET_GCODE_VARIABLE MACRO=RESUME_PRINT VARIABLE=efan VALUE={printer["fan_generic cooling_fan"].speed *255}
        SET_GCODE_VARIABLE MACRO=RESUME_PRINT VARIABLE=echambertemp VALUE={printer['heater_generic chamber'].target}

        DISABLE_ALL_SENSOR
        {% if printer.save_variables.variables.box_count >= 1 and printer["box_extras"] and printer.save_variables.variables.enable_box == 1 %}
            BUFFER_MONITORING ENABLE=0 
        {% endif %}
        SAVE_GCODE_STATE NAME=PAUSE              
        BASE_PAUSE
        {% if printer.extruder.can_extrude %}
            G92 E0
            G1 E-5 F1800
        {% endif %}
        {% if "z" in printer.toolhead.homed_axes and (printer.gcode_move.position.z + z ) < printer['gcode_macro PRINTER_PARAM'].max_z_position %}
            G91
            G1 Z{z} F900
        {% else %}
            SET_GCODE_VARIABLE MACRO=RESUME_PRINT VARIABLE=zhop VALUE=0
        {% endif %}
        SAVE_GCODE_STATE NAME=PAUSEPARK
        {% if "xy"  in printer.toolhead.homed_axes %}
            G90
            G1 X{printer['gcode_macro PRINTER_PARAM'].clear_x_position} F9000
            G1 Y{printer['gcode_macro PRINTER_PARAM'].clear_y_position} F9000
        {% endif %}
        M104 S0
        SET_IDLE_TIMEOUT TIMEOUT=259200   #72H
        SET_STEPPER_ENABLE STEPPER=extruder enable=0
        {% set slot_sync = printer.save_variables.variables.slot_sync|default("slot-1") %}
        {% if printer['box_stepper ' ~ slot_sync] %}
            SET_STEPPER_ENABLE STEPPER='box_stepper '{slot_sync} enable=0
        {% endif %}
    {% endif %}

[gcode_macro RESUME_PRINT]
variable_zhop: 0
variable_etemp: 0
variable_efan: 0
variable_echambertemp: 0
gcode:
    {% set e = params.E|default(150)|int %}
    {% set tool_change = params.TOOL_CHANGE|default(0)|int %}
    
    
    {% if printer['pause_resume'].is_paused|int == 1 %}
        {% if printer.save_variables.variables.box_count >= 1 and printer.save_variables.variables.enable_box == 1 and printer.save_variables.variables.is_tool_change == 1 and printer["box_extras"]%}
            SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}
            MOVE_TO_TRASH
            {% if etemp > 0 %}
                M109 S{etemp|int}
            {% endif %}
            M83
            RESTORE_GCODE_STATE NAME=PAUSEPARK MOVE=1 MOVE_SPEED=200                            
            RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED=15
            BASE_RESUME
        {% else %}
            SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}
            {% if etemp > 0 %}
                M109 S{etemp|int}
            {% endif %}
            {% if printer.save_variables.variables.box_count >= 1 and printer["box_extras"] %} 
                SAVE_VARIABLE VARIABLE=retry_step VALUE=None
            {% endif %}
            M83              
            M106 S{efan}
            {% if echambertemp > 0 %}
                M141 S{echambertemp|int}
            {% endif %}
            G1 X{printer['gcode_macro PRINTER_PARAM'].clear_x_position} F9000
            G1 Y{printer['gcode_macro PRINTER_PARAM'].clear_y_position} F9000
            {% if printer.extruder.can_extrude %}                  
                G91
                G1  E{e} F300
                G90
            {% endif %}
            {% if printer.save_variables.variables.box_count >= 1 and printer.save_variables.variables.enable_box == 1 %} 
                BUFFER_MONITORING ENABLE=1
            {% endif %}
            G1 X{printer['gcode_macro PRINTER_PARAM'].clear_x_position + 20} F15000
            G1 X{printer['gcode_macro PRINTER_PARAM'].clear_x_position} F5000
            G1 X{printer['gcode_macro PRINTER_PARAM'].clear_x_position + 20} F15000
            G1 X{printer['gcode_macro PRINTER_PARAM'].clear_x_position} F5000
            G1 X{printer['gcode_macro PRINTER_PARAM'].clear_x_position + 20} F15000
            G1 X{printer['gcode_macro PRINTER_PARAM'].clear_x_position} F5000
            G1 X{printer['gcode_macro PRINTER_PARAM'].clear_x_position + 20} F15000
            G1 X{printer['gcode_macro PRINTER_PARAM'].clear_x_position} F5000
            G1 Y{printer['gcode_macro PRINTER_PARAM'].clear_y_position - 50} F9000 
            RESTORE_GCODE_STATE NAME=PAUSEPARK MOVE=1 MOVE_SPEED=200                            
            RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED=15
            BASE_RESUME       
            {% if tool_change == 0 %}
                ENABLE_ALL_SENSOR
            {% endif %}
        {% endif %}
    {% endif %}
    

[gcode_macro RESUME]
rename_existing: BASE_RESUME
variable_zhop: 0
variable_etemp: 0
variable_efan: 0
variable_echambertemp: 0
gcode:
    {% if printer['pause_resume'].is_paused|int == 1 %}
        {% if printer.save_variables.variables.box_count >= 1 and printer["box_extras"] %} 
            {% if printer.save_variables.variables.enable_box == 1 %}
                TRY_RESUME_PRINT
            {% else %}
                {% if printer['filament_switch_sensor filament_switch_sensor'].filament_detected == True %}
                    RESUME_PRINT
                {% else %}
                    M118 Please load filament
                {% endif %}
            {% endif %}
        {% else %}
            {% if printer['filament_switch_sensor filament_switch_sensor'].filament_detected == True %}
                RESUME_PRINT
            {% else %}
                M118 Please load filament
            {% endif %}
        {% endif %}
    {% endif %}

[gcode_macro RESUME_1]
gcode:
    {% set extruder_temp = params.EXTRUDER|default(240)|int %}
    {% if printer.save_variables.variables.box_count >= 1 and printer["box_extras"] %} 
        {% if printer.save_variables.variables.enable_box == 1 %}
            RESUME_PRINT_1 S={extruder_temp}
        {% else %}
            {% if printer['filament_switch_sensor filament_switch_sensor'].filament_detected == False %}
                M118 Please load filament
            {% endif %}
        {% endif %}
    {% else %}
        {% if printer['filament_switch_sensor filament_switch_sensor'].filament_detected == False %}
            M118 Please load filament
        {% endif %}
    {% endif %}




[gcode_macro M141]
gcode:
    {% if printer["heater_generic chamber"] is defined %}
        {% set s = params.S|float %}
        SET_HEATER_TEMPERATURE HEATER=chamber TARGET={([s, 65]|min)}
    {% endif %}


[gcode_macro M191]
gcode:
    {% if printer["heater_generic chamber"] is defined %}
        {% set s = params.S|float %}
    
        M141 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  
        {% if s != 0 %}
            TEMPERATURE_WAIT SENSOR="heater_generic chamber" MINIMUM={([s, 65]|min)-2}
        {% endif %}
    {% endif %}
     
[gcode_macro M106]
gcode:
    {% set p = params.P|default(0)|int %}

    {% if p == 2 %}
    {% if params.S is defined %}
        SET_FAN_SPEED FAN=auxiliary_cooling_fan SPEED={(params.S|float / 255.0)}
    {% else %}
        SET_FAN_SPEED FAN=auxiliary_cooling_fan SPEED=1
    {% endif %}
    {% endif %} 

    {% if p == 0 %}
    {% if params.S is defined %}
        SET_FAN_SPEED FAN=cooling_fan SPEED={(params.S|float / 255.0)}
        
    {% else %}
        SET_FAN_SPEED FAN=cooling_fan SPEED=1
    {% endif %}
    {% endif %} 

    {% if p == 3 %}
    {% if params.S is defined %}
        SET_FAN_SPEED FAN=chamber_circulation_fan SPEED={(params.S|float / 255.0)}
    {% else %}
        SET_FAN_SPEED FAN=chamber_circulation_fan SPEED=1
    {% endif %}
    {% endif %} 

    {% if p == 4 %}
        {% if params.S is defined %}
            SET_PIN PIN=Polar_cooler VALUE={1 if (params.S|int / 255) > 0 else 0}
        {% else %}
            SET_PIN PIN=Polar_cooler VALUE=1
        {% endif %}
    {% endif %}

[gcode_macro M107]
gcode:  
    SET_FAN_SPEED FAN=cooling_fan SPEED=0

[gcode_macro M303]
gcode:
    {% if params.E is defined %}
     {% if params.S is defined %}
        {% if (params.E|int)==-1 %} 
         PID_CALIBRATE HEATER=heater_bed TARGET={params.S|int}
        {% endif %}
        {% if (params.E|int)==0 %}
         PID_CALIBRATE HEATER=extruder TARGET={params.S|int}
        {% endif %}
     {% endif %}
  {% endif %}


[gcode_macro M900]
gcode:
    {% if params.K is defined %} 
          SET_PRESSURE_ADVANCE ADVANCE={params.K}
    {% endif %}  
    {% if params.T is defined %}    
       SET_PRESSURE_ADVANCE SMOOTH_TIME={params.T}
    {% endif %} 

[gcode_macro M290]
gcode:
   SET_GCODE_OFFSET Z_ADJUST={params.Z}

[gcode_macro M901]
gcode:
    m104 S0         #共振关闭喷头温度
    G28
    SHAPER_CALIBRATE
    M118 Input shaper complete
    SAVE_CONFIG
       
[gcode_macro M0]
gcode:
    PAUSE

[gcode_macro M25]
rename_existing: M9925
gcode:
    PAUSE

[gcode_macro M4029]
gcode:
    {% set bedtemp = params.S|default(60)|float %}
    DISABLE_ALL_SENSOR
    M104 S140
    M140 S{bedtemp}
    SAVE_VARIABLE VARIABLE=z_offset VALUE=0
    SET_GCODE_OFFSET Z=0 MOVE=0
    M4031
    G28 
    M400
    M118 Position init complete

    CLEAR_NOZZLE HOTEND=260
    M104 S140
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM=140
    M118 Nozzle cooled
    Z_TILT_ADJUST
    G28
    G1 z10 F600
    BED_MESH_CALIBRATE
    G0 Z50 F600
    G0 X130 Y130 F9000
    M400
    M118 Bed mesh calibrate complete
    SAVE_CONFIG


[gcode_macro move_screw1]
gcode:
    G1 Z5 F600
    G1 X30 Y32 F12000
    G1 Z0 F300

[gcode_macro move_screw2]
gcode:
    G1 Z5 F600
    G1 X240 Y32 F12000
    G1 Z0 F300
    
[gcode_macro move_screw3]
gcode:
    G1 Z5 F600
    G1 X240 Y242 F12000
    G1 Z0 F300

[gcode_macro move_screw4]
gcode:
    G1 Z5 F600
    G1 X30 Y242 F12000
    G1 Z0 F300

[gcode_macro M4030]
gcode:    
    BED_MESH_CLEAR      
    SET_GCODE_OFFSET Z=0 MOVE=0
    M4031
    G28
    G1 X240 Y32 F9000
    G28 Z
    G1 Z0 F600

[gcode_macro M4031]
gcode:
    SET_TMC_CURRENT STEPPER=stepper_z CURRENT={printer.configfile.settings['tmc2209 stepper_z'].run_current * 0.8 }
    SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT={printer.configfile.settings['tmc2209 stepper_z1'].run_current * 0.8 }
    REVERSE_HOMING
    SET_TMC_CURRENT STEPPER=stepper_z CURRENT={printer.configfile.settings['tmc2209 stepper_z'].run_current}
    SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT={printer.configfile.settings['tmc2209 stepper_z1'].run_current}
    G91
    G1 Z-30 F600
    G90

    SET_TMC_CURRENT STEPPER=stepper_z CURRENT={printer.configfile.settings['tmc2209 stepper_z'].run_current * 0.8 }
    SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT={printer.configfile.settings['tmc2209 stepper_z1'].run_current * 0.8 }
    REVERSE_HOMING
    SET_TMC_CURRENT STEPPER=stepper_z CURRENT={printer.configfile.settings['tmc2209 stepper_z'].run_current}
    SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT={printer.configfile.settings['tmc2209 stepper_z1'].run_current}
    G91
    G1 Z-30 F600
    G90

[gcode_macro CUT_FILAMENT_1]
gcode:
    {% if "xy" not in printer.toolhead.homed_axes %}
        G28 X Y
    {% endif %}
    M204 S10000
    {% if (printer.gcode_move.position.x) < 15 %}
        G1 X15 F9000
        G1 Y0.5 F9000
    {% endif %}
    G1 Y0.5 F15000
    G1 X15 F15000
    G1 X-0.5 F5000
    G4 P1000
    G1 X1 F1000
    G1 X-0.5 F5000
    G4 P1000
    G1 X1 F1000
    G4 P1000
    G1 X15 F3000

[gcode_macro M603]
description: filament unlode
gcode:
    DISABLE_ALL_SENSOR
    {% set hotendtemp = params.S|default(250)|int %}
    _CG28
    M104 S{hotendtemp}

    MOVE_TO_TRASH
    M109 S{hotendtemp}
    M118 Heat up complete

    G92 E0 
    G1 E-10 F300     #退料10mm

    {% if printer.save_variables.variables.box_count > 0 and printer["box_extras"]%}
        E_UNLOAD SLOT=16
    {% else %}
        CUT_FILAMENT_1
        MOVE_TO_TRASH
        G92 E0 
        G1 E-60 F300     #退料60mm
    {% endif %}

    M104 S0

    G1 X{printer['gcode_macro PRINTER_PARAM'].clear_x_position + 20} F15000
    G1 X{printer['gcode_macro PRINTER_PARAM'].clear_x_position} F5000
    G1 X{printer['gcode_macro PRINTER_PARAM'].clear_x_position + 20} F15000
    G1 X{printer['gcode_macro PRINTER_PARAM'].clear_x_position} F5000
    G1 X{printer['gcode_macro PRINTER_PARAM'].clear_x_position + 20} F15000
    G1 X{printer['gcode_macro PRINTER_PARAM'].clear_x_position} F5000
    G1 X{printer['gcode_macro PRINTER_PARAM'].clear_x_position + 20} F15000
    G1 X{printer['gcode_macro PRINTER_PARAM'].clear_x_position} F5000

    M106 S0
    M400
    M118 Unload finish

[gcode_macro M604]
gcode:
    DISABLE_ALL_SENSOR
    {% set hotendtemp = params.S|default(250)|int %}
    {% set mode = params.T|default(0)|int %}
    {% if mode == 0 %} 
        _CG28
        MOVE_TO_TRASH
    {% endif %}
    {% if printer.save_variables.variables.box_count > 0 and mode == 0 and printer["box_extras"]%}
        M118 check box filament
        E_LOAD SLOT=16 S={hotendtemp}
    {% endif %}
    {% if mode == 0 %}  #第一次进料
        M104 S{hotendtemp}
        MOVE_TO_TRASH
        M109 S{hotendtemp}
        M118 Heat up complete
        G92 E0
        G1 E80 F400
        M400
    {% elif mode ==1 %}      #重试发送 M=1
        MOVE_TO_TRASH
        M109 S{hotendtemp}
        M118 Heat up complete
        G92 E0
        G1 E80 F400
        M400
    {% endif %}
    M118 Load finish

[gcode_arcs]
resolution: 1.0

[gcode_macro M109]
rename_existing: M99109
gcode:
    {% set s = params.S|float %}
    
    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s} MAXIMUM={s+1}
    {% endif %}

[exclude_object]

[gcode_macro G31]
gcode:
    SET_GCODE_VARIABLE MACRO=G29 VARIABLE=k VALUE=1

[gcode_macro G32]
gcode:
    SET_GCODE_VARIABLE MACRO=G29 VARIABLE=k VALUE=0



[gcode_macro G29]
variable_k:1
gcode:
    BED_MESH_CLEAR
    SET_STEPPER_ENABLE STEPPER=extruder enable=0
    {% if k|int==1 %}
        G28   
        BED_MESH_CALIBRATE PROFILE=kamp       
        SAVE_VARIABLE VARIABLE=profile_name VALUE='"kamp"'
        G4 P5000
        SAVE_CONFIG_QD 
    {% else %}
        {% if printer["bed_mesh"].profiles.default %}
            G28
            BED_MESH_PROFILE LOAD=default
            SAVE_VARIABLE VARIABLE=profile_name VALUE='"default"'
        {% else %}
            G28
            BED_MESH_CALIBRATE PROFILE=default
            SAVE_VARIABLE VARIABLE=profile_name VALUE='"default"'
            G4 P5000
            SAVE_CONFIG_QD
        {% endif %}
    {% endif %}

[gcode_macro M204]
rename_existing: M99204
gcode:
    {% if params.S is defined %}
        {% set s = params.S|float %}
    {% endif %}
    {% if params.P is defined %}
    {% if params.T is defined %}
        {% set s = [params.P|float ,params.T|float] | min %}
    {% endif %}
    {% endif %}

    SET_VELOCITY_LIMIT ACCEL={s}
    SET_VELOCITY_LIMIT ACCEL_TO_DECEL={s/2}

[gcode_macro BEEP]
gcode:
    {% set i = params.I|default(1)|int %}
    {% set dur = params.DUR|default(100)|int %}
    {% set beep = printer.save_variables.variables.beep|default(0) %}

    {% if beep == 1 %}
        {% for iteration in range(i|int) %}
            SET_PIN PIN=beeper VALUE=1
            G4 P{dur}
            SET_PIN PIN=beeper VALUE=0
    		G4 P{dur}
        {% endfor %}
    {% endif %}

[gcode_macro beep_on]
gcode:
    SAVE_VARIABLE VARIABLE=beep VALUE=1

[gcode_macro beep_off]
gcode:
    SAVE_VARIABLE VARIABLE=beep VALUE=0

[gcode_macro LED_ON]
gcode:
    SET_PIN PIN=caselight VALUE=1

[gcode_macro LED_OFF]
gcode:
    SET_PIN PIN=caselight VALUE=0